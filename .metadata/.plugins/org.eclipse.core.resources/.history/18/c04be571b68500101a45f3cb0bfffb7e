#include <stdint.h>
#include <main.h>

GPIO_Handle_TypeDef gpio_handle;
uint8_t read_input = 0;

void GPIO_USER_INIT(void);

int main(void) {
	GPIO_USER_INIT();

	GPIO_IRQ_SetPriority(IRQ9_EXTI3, 15);
	GPIO_IRQ_Config(IRQ9_EXTI3, ENABLE);
	while (1) {
		GPIO_OUTPUT(GPIOA, GPIO_PIN_8, HIGH);
		for (uint32_t i = 0; i < 50000; i++)
			;
		GPIO_OUTPUT(GPIOA, GPIO_PIN_8, LOW);
		for (uint32_t i = 0; i < 50000; i++)
			;
		GPIO_TOGGLE(GPIOD, GPIO_PIN_13);
		for (uint32_t i = 0; i < 50000; i++)
			;
	}
}

void GPIO_USER_INIT(void) {
	gpio_handle.GPIOX = GPIOA;
	gpio_handle.pin_number = GPIO_PIN_8;
	gpio_handle.mode = GPIO_MODE_OUTPUT;
	gpio_handle.output_speed = GPIO_OUTPUT_SPEED_VERY_HIGH;
	gpio_handle.output_type = GPIO_OUTPUT_TYPE_PP;
	gpio_handle.pull_up_pull_down = GPIO_PUPD_NONE;
	GPIO_INIT(&gpio_handle);

	gpio_handle.GPIOX = GPIOE;
	gpio_handle.pin_number = GPIO_PIN_1;
	GPIO_INIT(&gpio_handle);

	gpio_handle.GPIOX = GPIOD;
	gpio_handle.pin_number = GPIO_PIN_13;
	GPIO_INIT(&gpio_handle);

	gpio_handle.GPIOX = GPIOB;
	gpio_handle.pin_number = GPIO_PIN_3;
	gpio_handle.mode = GPIO_MODE_INTERRUPT_FALLING;
	gpio_handle.pull_up_pull_down = GPIO_PUPD_PU;
	gpio_handle.exti_select = EXTI_PORT_PB;
	GPIO_INIT(&gpio_handle);
}

void EXTI4_IRQHandler(void) {
	GPIO_TOGGLE(GPIOE, GPIO_PIN_1);
	GPIO_IRQHandling(GPIO_PIN_3);
}
