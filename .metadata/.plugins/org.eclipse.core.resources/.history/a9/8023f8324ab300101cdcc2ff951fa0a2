#include <ds1307.h>

static uint8_t decimal_to_bcd(uint8_t decimal) {
	uint8_t first = decimal % 10;
	uint8_t second = decimal / 10;
	return ((second << Shift_4_pos) | first);
}

static uint8_t bcd_to_decimal(uint8_t bcd) {
	uint8_t first = bcd & 0xF;
	uint8_t second = ((bcd >> Shift_4_pos) * 10);
	return (second + first);
}

void DS1307_WRITE(I2C_Handle_TypeDef *i2c_handle, uint8_t reg_addr,
		uint8_t data) {
	uint8_t value[2];
	value[0] = reg_addr;
	value[1] = data;
	I2C_Master_Write(i2c_handle, DS1307_BUS_ADDR, value, 2, I2C_SR_DIS);
}

void DS1307_READ(I2C_Handle_TypeDef *i2c_handle, uint8_t reg_addr,
		uint8_t *data) {
	I2C_Master_Write(i2c_handle, DS1307_BUS_ADDR, &reg_addr, 1, I2C_SR_DIS);
	I2C_Master_Read(i2c_handle, DS1307_BUS_ADDR, data, 1, I2C_SR_DIS);
}

// Return 1: CH = 1 --> INIT FAILED
// Return 0: CH = 0 --> INIT SUCCESS
uint8_t DS1307_INIT(I2C_Handle_TypeDef *i2c_handle) {
// Make clock halt
	uint8_t clock_state;

	// Read current seconds register
	DS1307_READ(i2c_handle, DS1307_SEC_REG, &clock_state);

	/ Check if clock is halted (CH bit = bit 7)
	if ((clock_state >> Shift_7_pos) & HIGH) {
		// Clock is halted, clear CH bit to start it
		clock_state &= ~(HIGH << Shift_7_pos);// Clear bit 7
		DS1307_WRITE(i2c_handle, DS1307_SEC_REG, clock_state);

		// Verify it started
		DS1307_READ(i2c_handle, DS1307_SEC_REG, &clock_state);
		return ((clock_state >> Shift_7_pos) & HIGH);// Return 0 if success
	}

	// Clock is already running
	return 0;  // Success
}

void DS1307_SET_TIME(I2C_Handle_TypeDef *i2c_handle, DS1307_time_t *ds1307_time) {
	uint8_t seconds = decimal_to_bcd(ds1307_time->seconds);
	uint8_t minutes = decimal_to_bcd(ds1307_time->minutes);
	uint8_t hours = decimal_to_bcd(ds1307_time->hours);
	if (ds1307_time->time_format != DS1307_TIME_FORMAT_24HRS) {
		// 12-hour mode
		hours |= (HIGH << Shift_6_pos); // Set bit 6 for 12-hour mode

		if (ds1307_time->time_format == DS1307_TIME_FORMAT_12HRS_PM) {
			hours |= (HIGH << Shift_5_pos); // Set bit 5 for PM
		}

	} else if (ds1307_time->time_format == DS1307_TIME_FORMAT_24HRS) {
		// 24-hour mode
		hours &= ~(HIGH << Shift_6_pos); // Clear bit 6 for 24-hour mode
	}
	DS1307_WRITE(i2c_handle, DS1307_SEC_REG, seconds);
	DS1307_WRITE(i2c_handle, DS1307_MIN_REG, minutes);
	DS1307_WRITE(i2c_handle, DS1307_HOUR_REG, hours);

}

void DS1307_GET_TIME(I2C_Handle_TypeDef *i2c_handle, DS1307_time_t *ds1307_time) {
	uint8_t seconds, minutes, hours;
	// Read from DS1307
	DS1307_READ(i2c_handle, DS1307_SEC_REG, &seconds);
	DS1307_READ(i2c_handle, DS1307_MIN_REG, &minutes);
	DS1307_READ(i2c_handle, DS1307_HOUR_REG, &hours);

	// Clear CH bit from seconds
	seconds &= ~(1 << Shift_7_pos);
	ds1307_time->seconds = bcd_to_decimal(seconds);
	ds1307_time->minutes = bcd_to_decimal(minutes);

	uint8_t hour_mode = ((hours >> Shift_6_pos) & 0x1);
	// 12-hour mode
	if (hour_mode == HIGH) {
		uint8_t AM_PM = ((hours >> Shift_5_pos) & 0x1);
		if (AM_PM == HIGH) {
			ds1307_time->time_format = DS1307_TIME_FORMAT_12HRS_PM;
		} else {
			ds1307_time->time_format = DS1307_TIME_FORMAT_12HRS_AM;
		}
		// Clear mode bits and convert
		hours &= 0x1F;  // Keep only lower 5 bits
	}
	// 24-hour mode
	else {
		ds1307_time->time_format = DS1307_TIME_FORMAT_24HRS;
		hours &= 0x3F;  // Keep only lower 6 bits
	}
	ds1307_time->hours = bcd_to_decimal(hours);
}

void DS1307_SET_DATE(I2C_Handle_TypeDef *i2c_handle, DS1307_date_t *ds1307_date) {
	uint8_t date, month, year, day;

	// Convert to BCD
	date = decimal_to_bcd(ds1307_date->date);
	month = decimal_to_bcd(ds1307_date->month);
	year = decimal_to_bcd(ds1307_date->year);
	day = ds1307_date->day;  // Day is 1-7, no BCD conversion needed

	// Write to DS1307
	DS1307_WRITE(i2c_handle, DS1307_DAY_REG, day);
	DS1307_WRITE(i2c_handle, DS1307_DATE_REG, date);
	DS1307_WRITE(i2c_handle, DS1307_MONTH_REG, month);
	DS1307_WRITE(i2c_handle, DS1307_YEAR_REG, year);
}

void DS1307_GET_DATE(I2C_Handle_TypeDef *i2c_handle, DS1307_date_t *ds1307_date) {
	uint8_t date, month, year, day;

	// Read from DS1307
	DS1307_READ(i2c_handle, DS1307_DAY_REG, &day);
	DS1307_READ(i2c_handle, DS1307_DATE_REG, &date);
	DS1307_READ(i2c_handle, DS1307_MONTH_REG, &month);
	DS1307_READ(i2c_handle, DS1307_YEAR_REG, &year);

	// Convert from BCD
	ds1307_date->day = day;
	ds1307_date->date = bcd_to_decimal(date);
	ds1307_date->month = bcd_to_decimal(month);
	ds1307_date->year = bcd_to_decimal(year);
}
